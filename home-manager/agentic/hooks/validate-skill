#!/usr/bin/env bash
set -euo pipefail

file_path=$(jq -r '.tool_input.file_path // empty')
if [[ -z "$file_path" ]]; then
  exit 0
fi

# Find the skill directory by walking up to a SKILL.md
skill_dir=""
if [[ "$(basename "$file_path")" == "SKILL.md" ]]; then
  skill_dir="$(dirname "$file_path")"
else
  dir="$(dirname "$file_path")"
  while [[ "$dir" != "/" && "$dir" != "." ]]; do
    if [[ -f "$dir/SKILL.md" ]]; then
      skill_dir="$dir"
      break
    fi
    dir="$(dirname "$dir")"
  done
fi

if [[ -z "$skill_dir" ]]; then
  exit 0
fi

if ! output=$(skills-ref validate "$skill_dir" 2>&1); then
  jq -n --arg reason "$output" '{"decision":"block","reason":$reason}'
  exit 2
fi
